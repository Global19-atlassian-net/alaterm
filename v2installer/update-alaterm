#!/bin/bash
# This script updates installed Alaterm.
# Usage, from within launched Alaterm:
# Enter this folder, then command:  bash update-alaterm

let v2latest=220

# Location of this script file, even if called from somewhere else:
export here="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
cd "$here" # Update component files are relative to $here.

# Test whether ordinary user or developer:
if [[ "$here" =~ TAexp-min ]] ; then # Developer only.
	if [ ! -f /status ] ; then # Preliminary file test, Alaterm not launched.
		export alatermTop="$PREFIX/../../alaterm-dev"
		if [ ! -d "$alatermTop" ] ; then
			echo "You did not install alaterm-dev yet!" ; exit 1
		fi
		export launchCommand="alaterm-dev"
		export termuxPrefix="$PREFIX"
		export termuxHome="$HOME"
		export userLocale="te_ST"
		let scriptRevision=200 # Dummy, lower than any update.
	fi
else # Ordinary users, in launched Alaterm.
	if  [ -r "/status" ] ; then
		chmod 755 "$alatermTop"
		chmod 644 "/status"
	else
		echo -e "\e[1;91mPROBLEM.\e[0m Did not find readable /status file."
		echo "This script must be launched from within Alaterm."
		exit 1
	fi
fi

# Load variables and functions:
source "$here/process/globals.bash" # Also sources /status, if there.

# Test whether Alaterm is updateable:
if [ "$scriptRevision" = "" ] || [ "$scriptRevision" -lt 40 ] ; then
	echo "Your Alaterm installation is too old for updates."
	echo "Nothing done. Consider fresh re-install."
	exit 1
fi

# Test whether already up-to-date:
if [ "$scriptRevision" -ge "$v2latest" ] ; then
	echo "Your installation is up-to-date."
	echo "Its scriptRevision is $scriptRevision"
	echo "Nothing done."
	exit 0
fi

# Quick test for downloaded stuff. Does not test everything:
gotupstuff="yes"
[ ! -d "$here/help-alaterm" ] && gotupstuff="no"
[ ! -d "$here/templates" ] && gotupstuff="no"
[ ! -d "$here/process" ] && gotupstuff="no"
[ ! -f "$here/process/globals.bash" ] && gotupstuff="no"
if [ "$gotupstuff" = "no" ] ; then
	echo -e "$PROBLEM You do not have all the necessary files."
	echo "Get all of the Alaterm repository ZIP, at:"
	echo "  https://github.com/cargocultprog/alaterm"
	echo "Unzip it in launched Alaterm, and try again."
	exit 1
fi

# Make backup copy of original status file, if not already done:
if [ -f "$alatermTop/status" ] && [ ! -f "$alatermTop/status.orig" ] ; then
	cp "$alatermTop/status" "$alatermTop/status.orig"
	[ -z "$devmode" ] && chmod 400 "$alatermTop/status.orig"
fi

# Generic finish:
update_done() {
	echo "let scriptRevision=$v2latest" >> "$alatermTop/status"
	printf " DONE.\n"
	exit 0
}


## Now for the update:
## ---------------------------------------------------------------------------

printf "Updating Alaterm..."


### Updates past 220 and including v2latest=222:
# [ "$scriptRevision" -ge 222 ] && update_done
# Updates for 222 go here.


### Updates up to and including v2latest=220:
[ "$scriptRevision" -ge 220 ] && update_done

## In case this was not done earlier:
mkdir -p "$alatermTop/system"
mkdir -p "$alatermTop/vendor"
mkdir -p "$alatermTop/odm"
mkdir -p "$alatermTop/home/.config/dbus"
mkdir -p "$alatermTop/home/.local/share/applications"

## Remove obsolete files:
rm -f "$alatermTop/usr/local/scripts/start-vnc" # Perl, not bash.
rm -f "$alatermTop/usr/local/scripts/stop-vnc" # Obsolete.
rm -f "$alatermTop/usr/bin/$launchCommand" # Now in /usr/local/scripts.
rm -f "$alatermTop/etc/pacman.d/hooks/fixdbuslaunch.hook" # Obsolete.
rm -f "$alatermTop/usr/local/scripts/fixdbuslaunch" # Obsolete.
rm -r -f "$alatermTop/usr/local/alaterm-help" # Now help-alaterm.

## Install or reinstall templates that should not have user customization:
install_template "autoremove.bash" "755" && printf "."
install_template "ban-menu-items.bash" "755" && printf "."
install_template "ban-menu-items.hook" && printf "."
install_template "bash.bash_logout.bash" && printf "."
install_template "bash.bashrc.bash" && printf "."
install_template "compile-libde265.bash" "755" && printf "."
install_template "compile-libmad.bash" "755" && printf "."
install_template "compile-libmpeg2.bash" "755" && printf "."
install_template "dbus-programs.bash" "755" && printf "."
install_template "dbus-programs.hook" && printf "."
install_template "default-resolution.bash" "755" && printf "."
install_template "home.bash_profile.bash" && printf "."
install_template "home.vnc-xstartup.bash" "755" && printf "."
install_template "home.xinitrc.bash" && printf "."
install_template "launchcommand.bash" "755" && printf "."
install_template "menu.xml" && printf "."
install_template "mimeapps-list.bash" "755" && printf "."
install_template "mimeapps-list.hook" && printf "."
install_template "nanorc.conf" && printf "."
install_template "pkg.bash" "755" && printf "."
install_template "profile.bash" && printf "."
install_template "ps.bash" "755" && printf "."
install_template "readme-local.md" && printf "."
install_template "readme-trash.md" && printf "."
install_template "start-vnc.pl" "755" && printf "."
install_template "top.bash" "755" && printf "."
install_template "vncserver.bash" "755" && printf "."
install_template "vncviewer.bash" "755" && printf "."

## May have been mis-installed:
thisfile="$alatermTop/home/.Xdefaults"
[ ! -f "$thisfile" ] && install_template "home.Xdefaults.conf" && printf "."
thisfile="$alatermTop/home/.config/TUG/TeXworks.conf"
if [ -f "$thisfile" ] ; then
	grep PARSE "$thisfile" >/dev/null 2>&1
	if [ "$?" -eq 0 ] ; then
		sed -i "s!PARSE\$userLocale!$userLocale!" "$thisfile"
	fi
	printf "."
else
	install_template "TeXworks.conf" && printf "."
fi

## Remove bad line from bookmarks:
thisfile="$alatermTop/home/.config/gtk-3.0/bookmarks"
if [ -f "$thisfile" ] ; then
	sed -i '/file=/d' "$thisfile" && printf "."
else
	install_template "bookmarks.conf" && printf "."
fi

## Remove obsolete lines from /home/.bashrc. Aliases now in .bash_profile:
thisfile="$alatermTop/home/.bashrc"
sed -i '/alias ls/d' "$thisfile"
sed -i '/alias pacman/d' "$thisfile"
sed -i '/alias fc-cache/d' "$thisfile"
sed -i '/alias vncviewer/d' "$thisfile"
sed -i '/installed vncviewer/d' "$thisfile" && printf "."

## These templates do not need edit or reinstall:
# root.bashrc.bash
# root.bash_profile.bash
# lxde-rc.xml
# home.vnc-config.conf
# panel.conf
# desktop-items-0.conf

## These templates are only used during initial install. Never reinstalled:
# getlxde-profile.bash
# getlxde-launch.bash
# prelim-profile.bash
# prelim-launch.bash

## Re-install help files, to ensure latest:
cp -r "$here/help-alaterm" "$alatermTop/usr/local/"
printf "."

## 220 done:
cp "$alatermTop/usr/local/scripts/$launchCommand" "$termuxPrefix/bin"
update_done
##
